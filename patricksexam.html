<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Patrick Exam</title>

  <link rel="stylesheet" href="css/common.css">
  <link href="https://fonts.googleapis.com/css2?family=Roboto+Slab:wght@900&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#0b3b4a;
      --shadow:0 18px 35px rgba(0,0,0,.45);
    }

    body{
      margin:0;
      background:var(--bg);
      font-family:"Roboto Slab", serif;
      overflow:hidden;
      display:flex;
      align-items:center;
      justify-content:center;
      width:100vw;
      height:100vh;
    }

    .stage{
      position:relative;
      width:min(1200px, 92vw);
      height:min(720px, 84vh);
      background:var(--bg);
      border:4px solid rgba(0,0,0,.45);
      box-shadow:0 26px 55px rgba(0,0,0,.45);
      overflow:hidden;
      padding:18px;
      box-sizing:border-box;
    }

    .title{
      color:#fff;
      font-weight:900;
      font-size:clamp(24px, 3.2vw, 44px);
      text-align:center;
      margin:10px 0 14px;
    }

    .strip{
      position:relative;
      width:100%;
      height:calc(100% - 120px);
      display:flex;
      align-items:center;
      justify-content:center;
    }

    .photo-wrap{
      position:relative;
      height:min(420px, 58vh);
      border-radius:14px;
      overflow:hidden;
      box-shadow:var(--shadow);
      background:#000;
    }

    .photo-left{ width:min(760px, 68%); z-index:2; }
    .photo-right{ width:min(520px, 46%); margin-left:-110px; z-index:1; }

    .photo-wrap img{
      width:100%;
      height:100%;
      object-fit:cover;
      pointer-events:none;
    }

    /* --- Vitals monitor glow (RIGHT image) --- */
    .monitor-glow{
      position:absolute;
      right: 18px;
      top: 18px;
      width: 14px;
      height: 14px;
      border-radius: 999px;
      background: radial-gradient(circle at 35% 35%, rgba(180,255,180,1) 0%, rgba(0,255,120,.95) 35%, rgba(0,255,120,.25) 70%, rgba(0,255,120,0) 100%);
      box-shadow:
        0 0 10px rgba(0,255,120,.65),
        0 0 22px rgba(0,255,120,.45),
        0 0 42px rgba(0,255,120,.28);
      opacity:.25;
      animation: blinkGlow 1.15s ease-in-out infinite;
      pointer-events:none;
      z-index:8;
    }
    .monitor-glow::after{
      content:"";
      position:absolute;
      inset:-14px;
      border-radius:999px;
      background: radial-gradient(circle, rgba(0,255,120,.18) 0%, rgba(0,255,120,0) 70%);
      filter: blur(2px);
      opacity:.9;
    }
    @keyframes blinkGlow{
      0%, 100% { transform: scale(.96); opacity:.18; filter: brightness(.95); }
      50%      { transform: scale(1.12); opacity:.78; filter: brightness(1.2); }
    }

    /* =======================
       GCS: more dynamic
       ======================= */
    .gcs{
      position:absolute;
      top:138px;
      right:44px;
      width:180px;
      height:96px;
      border-radius:999px;
      border: 2px solid rgba(255,255,255,.22);

      background: radial-gradient(circle at 30% 25%, rgba(255,255,255,.20), rgba(0,0,0,0) 55%),
                  linear-gradient(180deg, #ff8a2a 0%, #c85d18 55%, #a4470d 100%);

      color:#fff;
      font-weight:900;
      display:flex;
      align-items:center;
      justify-content:center;
      text-decoration:none;
      cursor:pointer;
      z-index:50;
      user-select:none;

      box-shadow:
        0 18px 30px rgba(0,0,0,.35),
        inset 0 0 0 2px rgba(255,255,255,.10);

      transition: transform .14s ease, filter .14s ease, box-shadow .18s ease;
    }
    .gcs:hover{
      transform: translateY(-2px) scale(1.02);
      filter: brightness(1.05);
      box-shadow:
        0 22px 36px rgba(0,0,0,.38),
        0 0 18px rgba(255,170,70,.30),
        inset 0 0 0 2px rgba(255,255,255,.12);
    }
    .gcs:active{
      transform: translateY(0) scale(.99);
      filter: brightness(.98);
    }
    .gcs:focus-visible{
      outline: 4px solid rgba(255,255,255,.75);
      outline-offset: 4px;
    }

    .gcs-inner{
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap: 2px;
      line-height:1;
      text-align:center;
    }

    .gcs-label{
      font-size:18px;
      letter-spacing:.8px;
      opacity:.95;
    }

    .gcs-value{
      font-size:40px;
      letter-spacing:.5px;
      text-shadow: 0 3px 0 rgba(0,0,0,.20);
    }

    .gcs-hint{
      font-size:12px;
      font-weight:800;
      opacity:.95;
      letter-spacing:.35px;
    }

    /* pulse when opened */
    .gcs.is-open{
      animation: gcsPulse .9s ease-in-out;
    }
    @keyframes gcsPulse{
      0% { transform: scale(1); }
      35% { transform: scale(1.04); }
      100% { transform: scale(1); }
    }

    /* subtle “ping” dot */
    .gcs-dot{
      position:absolute;
      left: 14px;
      top: 50%;
      transform: translateY(-50%);
      width: 10px;
      height: 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.9);
      box-shadow: 0 0 12px rgba(255,255,255,.55);
      opacity:.85;
      animation: dotBlink 1.4s ease-in-out infinite;
    }
    @keyframes dotBlink{
      0%, 100% { opacity:.35; transform: translateY(-50%) scale(.9); }
      50% { opacity:1; transform: translateY(-50%) scale(1.08); }
    }

    /* =======================
       GCS mini-panel (popover)
       ======================= */
    .gcs-pop{
      position:absolute;
      top: 250px;
      right: 44px;
      width: min(360px, 84vw);
      background: rgba(0,0,0,.72);
      border: 1px solid rgba(255,255,255,.18);
      border-radius: 16px;
      padding: 14px 14px;
      box-shadow: 0 22px 42px rgba(0,0,0,.5);
      z-index: 60;
      display:none;
      backdrop-filter: blur(6px);
    }
    .gcs-pop.is-open{ display:block; }

    .gcs-pop h3{
      margin: 0 0 10px;
      color:#fff;
      font-weight:900;
      font-size: 18px;
      letter-spacing:.3px;
    }

    .gcs-grid{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 10px;
      margin-bottom: 10px;
    }

    .gcs-pill{
      background: rgba(255,255,255,.92);
      color:#111;
      border: 0;
      border-radius: 14px;
      padding: 10px 8px;
      font-weight: 900;
      cursor:pointer;
      box-shadow: 0 10px 18px rgba(0,0,0,.28);
      transition: transform .12s ease, filter .12s ease;
    }
    .gcs-pill:hover{ transform: translateY(-2px); filter: brightness(1.03); }
    .gcs-pill:active{ transform: translateY(1px) scale(.99); filter: brightness(.98); }

    .gcs-pill.is-picked{
      outline: 4px solid rgba(255,196,0,.85);
      filter: brightness(1.02);
    }

    .gcs-summary{
      color: rgba(255,255,255,.92);
      font-weight: 800;
      font-size: 13px;
      line-height: 1.3;
    }

    .gcs-pop-close{
      margin-top: 10px;
      width: 100%;
      background: rgba(255,255,255,.15);
      color:#fff;
      border: 1px solid rgba(255,255,255,.22);
      border-radius: 12px;
      padding: 10px 10px;
      font-weight: 900;
      cursor:pointer;
    }
    .gcs-pop-close:hover{ filter: brightness(1.05); }

    /* --- HOTSPOTS --- */
    .hotspot{
      position:absolute;
      width:72px;
      height:72px;
      transform:translate(-50%,-50%);
      cursor:pointer;
      z-index:6;
    }

    .hotspot svg{
      width:100%;
      height:100%;
      filter:drop-shadow(0 6px 10px rgba(0,0,0,.45));
    }

    /* --- GIF MODAL --- */
    .modal{
      position:absolute;
      inset:0;
      background:rgba(0,0,0,.7);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:30;
    }
    .modal.is-open{ display:flex; }

    .modal-card{
      background:#fff;
      border-radius:16px;
      padding:14px;
      position:relative;
      width:min(860px, 92vw);
    }

    .gif-wrap{
      background:#000;
      width: 90%;
      border-radius:12px;
      overflow:hidden;
      display:flex;
      justify-content:center;
      align-items:center;
    }

    .gif-wrap img{
      max-height:auto;
      width:70vh;
      transition:transform .3s ease, filter .3s ease;
    }

    .gif-zoomed{ transform:scale(2.5); }
    .gif-bw{ filter:grayscale(100%); }

    .close{
      position:absolute;
      top:10px;
      right:12px;
      width:38px;
      height:38px;
      border-radius:50%;
      border:none;
      background:#111;
      color:#fff;
      cursor:pointer;
    }

    /* --- CALLOUT --- */
    .callout{
      position:absolute;
      bottom:28px;
      left:50%;
      transform:translateX(-50%);
      width:min(980px, 92%);
      background:#fff;
      border-radius:16px;
      padding:14px 18px;
      display:none;
      z-index:999;
      text-align:center;
      font-weight:700;
    }
    #calloutText{
      color:#111 !important;
      font-size:20px;
      line-height:1.3;
      display:block;
    }
    .callout.is-showing{ display:block; }

    /* --- NAV --- */
    .nav-arrow{
      position:absolute;
      bottom:18px;
      right:18px;
      z-index:50;
    }
    .nav-arrow img{ width:82px; }
  </style>
</head>

<body>
<div class="stage" id="stage">

  <div class="title">Patrick’s examination – click icons<br/>to hear/see</div>

  <!-- Dynamic GCS -->
  <button class="gcs" id="gcsBtn" type="button" aria-haspopup="dialog" aria-controls="gcsPop" aria-expanded="false">
    <span class="gcs-dot" aria-hidden="true"></span>
    <span class="gcs-inner">
      <span class="gcs-label">GCS</span>
      <span class="gcs-value" id="gcsValue"></span>
      <span class="gcs-hint" id="gcsHint">Tap to review</span>
    </span>
  </button>

  <!-- GCS Popover -->
  <div class="gcs-pop" id="gcsPop" role="dialog" aria-label="GCS details">
    <h3>Glasgow Coma Scale</h3>

    <div class="gcs-grid" id="gcsGrid">
      <button class="gcs-pill" type="button" data-e="4" data-v="5" data-m="6">Alert (E4 V5 M6)</button>
    </div>

    <div class="gcs-summary" id="gcsSummary">
      Patient is alert and worried.
    </div>

    <button class="gcs-pop-close" type="button" id="gcsClose">Close</button>
  </div>

  <div class="strip">

    <!-- LEFT -->
    <div class="photo-wrap photo-left">
      <img src="images/oldmanworriedinbedoxygenstethoscope.png" alt="Patrick exam front">

      <!-- MAG 1 -->
      <div class="hotspot"
           style="left:63%; top:42%;"
           data-type="gif"
           data-bw="true"
           data-gif="gifs/accMusoRespGif.gif">
        <svg viewBox="0 0 100 100">
          <circle cx="42" cy="42" r="22" fill="none" stroke="#c9ff00" stroke-width="6"/>
          <line x1="57" y1="57" x2="80" y2="80" stroke="#c9ff00" stroke-width="8"/>
        </svg>
      </div>

      <!-- MAG 2 -->
      <div class="hotspot"
           style="left:77%; top:48%;"
           data-type="gif"
           data-gif="gifs/pursedlipsgif.gif"
           data-zoom="2.5"
           data-bw="true">
        <svg viewBox="0 0 100 100">
          <circle cx="42" cy="42" r="22" fill="none" stroke="#c9ff00" stroke-width="6"/>
          <line x1="57" y1="57" x2="80" y2="80" stroke="#c9ff00" stroke-width="8"/>
        </svg>
      </div>

      <!-- LEFT AUDIO -->
      <div class="hotspot"
           style="left:66%; top:80%;"
           data-type="audio"
           data-audio="audio_left">
        <svg viewBox="0 0 120 120">
          <path d="M50 40 L30 40 L18 52 L18 68 L30 80 L50 80 L72 98 L72 22 Z"
                fill="#fff" stroke="#ff7a00" stroke-width="6"/>
        </svg>
      </div>
    </div>

    <!-- RIGHT -->
    <div class="photo-wrap photo-right">
      <img src="images/oldmanworriedinbedoxygenstethoscopeback.png" alt="Patrick exam back">
      <div class="monitor-glow" aria-hidden="true"></div>

      <div class="hotspot"
           style="left:35%; top:56%;"
           data-type="audio"
           data-audio="audio_right">
        <svg viewBox="0 0 120 120">
          <path d="M50 40 L30 40 L18 52 L18 68 L30 80 L50 80 L72 98 L72 22 Z"
                fill="#fff" stroke="#ff7a00" stroke-width="6"/>
        </svg>
      </div>
    </div>
  </div>

  <!-- Background monitor audio -->
  <audio id="bgMonitor" preload="auto" loop>
    <source src="audio/audioMonitorVitalsTachypnoea.m4a" type="audio/mp4">
  </audio>

  <!-- HOTSPOT AUDIO -->
  <audio id="audio_left" src="audio/audioHeartbeatLubDub.mp3" preload="auto"></audio>
  <audio id="audio_right" src="audio/audioWheezeTypeOne.mp3" preload="auto"></audio>

  <!-- GIF MODAL -->
  <div class="modal" id="modal">
    <div class="modal-card">
      <button class="close" id="closeModal">✕</button>
      <div class="gif-wrap">
        <img id="modalGif" alt="Modal GIF">
      </div>
    </div>
  </div>

  <!-- CALLOUT -->
  <div class="callout" id="callout"><span id="calloutText"></span></div>

  <!-- NAV -->
  <a class="nav-arrow" href="ptwhatwillyoudonext.html">
    <img src="images/nextslideorangeshape.png" alt="Next">
  </a>

</div>

<script>
  // ===== Background monitor audio (50% volume) =====
  const bgMonitor = document.getElementById("bgMonitor");
  bgMonitor.volume = 0.5;

  async function startBgAudio(){
    const ok = await bgMonitor.play().then(()=>true).catch(()=>false);
    return ok;
  }
  startBgAudio();

  let bgArmed = false;
  function armBgOnce(){
    if (bgArmed) return;
    bgArmed = true;
    startBgAudio();
    window.removeEventListener("pointerdown", armBgOnce);
    window.removeEventListener("keydown", armBgOnce);
  }
  window.addEventListener("pointerdown", armBgOnce, { once:true });
  window.addEventListener("keydown", armBgOnce, { once:true });

  // ===== GCS Dynamic logic =====
  const gcsBtn = document.getElementById("gcsBtn");
  const gcsPop = document.getElementById("gcsPop");
  const gcsClose = document.getElementById("gcsClose");
  const gcsValueEl = document.getElementById("gcsValue");
  const gcsHintEl = document.getElementById("gcsHint");
  const gcsSummary = document.getElementById("gcsSummary");
  const gcsGrid = document.getElementById("gcsGrid");

  function calcTotal(e,v,m){ return Number(e)+Number(v)+Number(m); }

  function openGcs(){
    gcsPop.classList.add("is-open");
    gcsBtn.classList.add("is-open");
    gcsBtn.setAttribute("aria-expanded","true");
    gcsHintEl.textContent = "Pick a state";
  }
  function closeGcs(){
    gcsPop.classList.remove("is-open");
    gcsBtn.setAttribute("aria-expanded","false");
    gcsHintEl.textContent = "Tap to review";
  }

  gcsBtn.addEventListener("click", ()=>{
    if (!bgArmed) { bgArmed = true; startBgAudio(); }
    if (gcsPop.classList.contains("is-open")) closeGcs(); else openGcs();
  });

  gcsClose.addEventListener("click", closeGcs);

  // pick a GCS scenario
  gcsGrid.addEventListener("click",(e)=>{
    const btn = e.target.closest(".gcs-pill");
    if(!btn) return;

    [...gcsGrid.querySelectorAll(".gcs-pill")].forEach(b=>b.classList.remove("is-picked"));
    btn.classList.add("is-picked");

    const E = btn.dataset.e, V = btn.dataset.v, M = btn.dataset.m;
    const total = calcTotal(E,V,M);

    gcsValueEl.textContent = String(total);

    // nice summary text
    let text = "Patient is alert and worried.";
    if (total <= 9) text = "Reduced conscious level — urgent escalation required.";
    else if (total <= 12) text = "Drowsy/confused — reassess frequently.";
    else if (total <= 14) text = "Mildly reduced — monitor and reassess.";
    gcsSummary.textContent = `E${E} V${V} M${M} (Total ${total}) — ${text}`;
  });

  // close popover if you click outside it
  document.addEventListener("pointerdown",(e)=>{
    if(!gcsPop.classList.contains("is-open")) return;
    const inside = gcsPop.contains(e.target) || gcsBtn.contains(e.target);
    if(!inside) closeGcs();
  });

  // ESC closes
  document.addEventListener("keydown",(e)=>{
    if(e.key === "Escape") closeGcs();
  });

  // ===== Existing interactions =====
  const modal = document.getElementById("modal");
  const modalGif = document.getElementById("modalGif");
  const callout = document.getElementById("callout");
  const calloutText = document.getElementById("calloutText");

  function openGifModal(src, zoom = 1, bw = false){
    modalGif.src = src;
    modalGif.classList.remove("gif-zoomed","gif-bw");
    if(zoom !== 1) modalGif.classList.add("gif-zoomed");
    if(bw) modalGif.classList.add("gif-bw");
    modal.classList.add("is-open");
  }

  document.getElementById("closeModal").onclick = () => modal.classList.remove("is-open");

  let calloutTimer;
  function showCallout(text, ms){
    calloutText.textContent = text;
    callout.classList.add("is-showing");
    clearTimeout(calloutTimer);
    calloutTimer = setTimeout(()=>callout.classList.remove("is-showing"), ms);
  }

  document.querySelectorAll(".hotspot").forEach(h=>{
    h.onclick = ()=>{
      if (!bgArmed) { bgArmed = true; startBgAudio(); }

      if(h.dataset.type === "gif"){
        openGifModal(
          h.dataset.gif,
          Number(h.dataset.zoom || 1),
          h.dataset.bw === "true"
        );
      }
      if(h.dataset.type === "audio"){
        const el = document.getElementById(h.dataset.audio);
        el.loop = true;
        if(h.dataset.audio === "audio_right"){
          el.playbackRate = 1.5;
          if(el.currentTime < 15) el.currentTime = 15;
          showCallout(
            "Profound volume loss on auscultation left lung causing acute hypoxaemia. The patient has a collapsed lung probably due to mucus plugging.",
            4000
          );
        } else {
          el.playbackRate = 2.0;
          el.currentTime = 0;
        }
        el.play().catch(()=>{});
      }
    };
  });
</script>

</body>
</html>
