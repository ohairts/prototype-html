<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Kardex</title>

  <link rel="stylesheet" href="css/common.css">
  <link rel="stylesheet" href="css/fly-in-options.css">
  <link href="https://fonts.googleapis.com/css2?family=Roboto+Slab:wght@900&display=swap" rel="stylesheet">

  <style>
    body {
      margin: 0;
      background: #08394a;
      font-family: "Roboto Slab", serif;
      overflow: hidden;
      color: #fff;
    }

    .stage {
      width: 100vw;
      height: 100vh;
      position: relative;
      overflow: hidden;
    }

    /* ===== LEFT INFO PANEL ===== */
    .info-panel{
      position: absolute;
      left: 18px;
      top: 120px;
      width: min(320px, 26vw);
      background: #ffc400;
      color: #111;
      border: 4px solid rgba(0,0,0,.35);
      border-radius: 16px;
      padding: 16px 16px;
      font-weight: 900;
      line-height: 1.15;
      text-align: center;
      box-shadow: 0 14px 26px rgba(0,0,0,.35);
      z-index: 4;
    }

    /* ====== INTRO TILE (shows for 3 seconds only) ====== */
    .intro-tile {
      position: fixed;
      left: 50%;
      top: 18px;
      transform: translateX(-50%);
      width: min(860px, 92vw);
      background: #ffffff;
      color: #111;
      border: 4px solid rgba(0,0,0,.35);
      border-radius: 18px;
      padding: 16px 18px;
      text-align: center;
      font-weight: 900;
      font-size: clamp(16px, 1.7vw, 22px);
      line-height: 1.2;
      z-index: 9999;
      box-shadow: 0 18px 35px rgba(0,0,0,.35);
      opacity: 0;
      transform: translateX(-50%) translateY(-6px);
      transition: opacity .25s ease, transform .25s ease;
      pointer-events: none;
    }
    .intro-tile.is-visible { opacity: 1; transform: translateX(-50%) translateY(0); }
    .intro-tile.is-hidden  { opacity: 0; transform: translateX(-50%) translateY(-8px); }

    .viewer {
      position: absolute;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      width: min(980px, 92vw);
      height: min(720px, 92vh);
      display: grid;
      grid-template-rows: auto 1fr auto;
      gap: 10px;
      z-index: 2;
    }

    .bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }

    .title {
      font-weight: 900;
      font-size: clamp(18px, 2vw, 26px);
      margin: 0;
    }

    .pager {
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: 900;
    }

    .btn {
      background: rgba(255,255,255,.10);
      border: 2px solid rgba(255,255,255,.22);
      color: #fff;
      border-radius: 12px;
      padding: 10px 14px;
      cursor: pointer;
      user-select: none;
      font-weight: 900;
      transition: transform .12s ease, filter .12s ease;
    }
    .btn:hover { transform: translateY(-1px); filter: brightness(1.06); }
    .btn:active { transform: translateY(1px) scale(.99); }
    .btn:disabled { opacity: .4; cursor: default; transform: none; }

    .page-stage {
      position: relative;
      border-radius: 14px;
      border: 2px solid rgba(0,0,0,.45);
      background: rgba(0,0,0,.25);
      box-shadow: 0 18px 40px rgba(0,0,0,.35);
      overflow: hidden;
    }

    .page-img {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      object-fit: contain;
      background: #0a0a0a;
      display: block;
      user-select: none;
      -webkit-user-drag: none;
    }

    .overlays { position: absolute; inset: 0; pointer-events: none; z-index: 6; }
    .overlay { position: absolute; height: auto; }
    .overlay img { width: 100%; height: auto; display: block; object-fit: contain; }

    .overlay.wipe-in { animation: overlayWipe .55s ease forwards; }
    @keyframes overlayWipe { from { clip-path: inset(0 100% 0 0); } to { clip-path: inset(0 0 0 0); } }

    /* ===== Page 2 sticky fly-in ===== */
    .p2-panel, .p8-panel{
      position: absolute;
      right: 18px;
      top: 120px;
      width: min(340px, 28vw);
      z-index: 85;
      display: flex;
      flex-direction: column;
      gap: 14px;
      padding: 14px;
      border-radius: 16px;
      background: rgba(0,0,0,.35);
      border: 2px solid rgba(255,255,255,.18);
      box-shadow: 0 14px 26px rgba(0,0,0,.35);
      opacity: 0;
      transform: translateX(10px);
      transition: opacity .18s ease, transform .18s ease;
    }
    .p2-panel.is-visible, .p8-panel.is-visible{ opacity: 1; transform: translateX(0); }
    .p2-panel.hidden, .p8-panel.hidden { display: none; }

    .p2-tile, .p8-tile{
      background: #121a8a;
      border: 2px solid rgba(255,255,255,.28);
      border-radius: 999px;
      padding: 16px 14px;
      text-align: center;
      color: #fff;
      font-weight: 900;
      cursor: pointer;
      user-select: none;
      box-shadow: 0 12px 18px rgba(0,0,0,.25);
      transition: transform .12s ease, filter .12s ease;
    }
    .p2-tile:hover, .p8-tile:hover { transform: translateY(-1px); filter: brightness(1.05); }
    .p2-tile:active, .p8-tile:active { transform: translateY(1px) scale(.99); filter: brightness(.98); }

    /* ===== White bubble ===== */
    .p2-bubble{
      position: absolute;
      right: 380px;
      top: 140px;
      width: min(520px, 44vw);
      background: #fff;
      color: #111;
      border: 4px solid rgba(0,0,0,.25);
      border-radius: 999px;
      padding: 18px 22px;
      font-weight: 900;
      font-size: clamp(14px, 1.5vw, 20px);
      text-align: center;
      line-height: 1.15;
      box-shadow: 0 14px 22px rgba(0,0,0,.25);
      z-index: 90;
      opacity: 0;
      transform: translate(16px, 10px) scale(.98);
      pointer-events: none;
      transition: opacity .18s ease, transform .18s ease;
    }
    .p2-bubble.is-visible { opacity: 1; transform: translate(0,0) scale(1); }
    .p2-bubble::after{
      content: "";
      position: absolute;
      right: 120px;
      bottom: -112px;
      border-left: 10px solid transparent;
      border-right: 10px solid transparent;
      border-top: 132px solid #fff;
      transform: rotate(-45deg);
      transform-origin: top center;
      filter: drop-shadow(0 8px 0 rgba(0,0,0,.14));
    }

    /* ===== Green next arrow ===== */
    .next-green{
      position: absolute;
      right: 22px;
      bottom: 22px;
      width: 110px;
      height: 86px;
      cursor: pointer;
      z-index: 95;
      user-select: none;
      filter: drop-shadow(0 10px 18px rgba(0,0,0,.35));
      transition: transform .15s ease, filter .2s ease;
    }
    .next-green img{ width: 100%; height: 100%; object-fit: contain; display: block; }
    .next-green:hover{
      transform: translateY(-2px) scale(1.03);
      filter: drop-shadow(0 0 12px rgba(46,215,20,.55))
              drop-shadow(0 12px 18px rgba(0,0,0,.35));
    }
    .hidden{ display:none; }
  </style>
</head>

<body>
  <div class="stage">

    <div class="info-panel">
      Review the patient's kardex and note any issues. (If there are any).
    </div>

    <div id="introTile" class="intro-tile" aria-live="polite">
      You decide to sit down with his Kardex. The medics have started it.
    </div>

    <div class="viewer">
      <div class="bar">
        <h1 class="title" id="kTitle">Medication Kardex</h1>
        <div class="pager">
          <button class="btn" id="prevBtn" type="button">◀ Prev</button>
          <div id="pageLabel">Page 1 / 8</div>
          <button class="btn" id="nextBtn" type="button">Next ▶</button>
        </div>
      </div>

      <div class="page-stage" id="pageStage">
        <img id="pageImg" class="page-img" alt="Kardex page">
        <div id="overlays" class="overlays"></div>
      </div>
    </div>

    <div id="p2Panel" class="p2-panel hidden" aria-label="Actions"></div>
    <div id="p2Bubble" class="p2-bubble" aria-live="polite"></div>

    <div id="p8Panel" class="p8-panel hidden" aria-label="Page 8 actions"></div>

    <!-- MUST be visible immediately on page 8; hidden on pages 1-7 -->
    <div id="p8Next" class="next-green hidden" title="Continue to discussion">
      <img src="images/nextSlideGreenShape.png" alt="Next">
    </div>

  </div>

  <script type="module">
    // ===== Intro tile show/hide =====
    const introTile = document.getElementById("introTile");
    introTile.classList.add("is-visible");
    setTimeout(() => {
      introTile.classList.add("is-hidden");
      introTile.classList.remove("is-visible");
      setTimeout(() => introTile.remove(), 350);
    }, 3000);

    const NUM_PAGES = 8;
    const KARDEX_PAGES = Array.from({ length: NUM_PAGES }, (_, i) => {
      const n = i + 1;
      return { title: `Kardex Page ${n}`, img: `images/kardex_page${n}.png`, overlays: [] };
    });

    // Overlays
    KARDEX_PAGES[0].overlays.push(
      { img: "images/kardex_page1_details.png",  x: 54,   y: 3,   w: 10 },
      { img: "images/kardex_page1_details2.png", x: 31.5, y: 18.5, w: 15 },
    );

    KARDEX_PAGES[1].overlays.push(
      { img: "images/kardex_page2_details.png",  x: 58, y: 3,  w: 10 },
      { img: "images/kardex_page2_details2.png", x: 30, y: 22, w: 28, id: "p2_details2" }
    );

    KARDEX_PAGES[7].overlays.push(
      { img: "images/kardex_page8_details.png",  x: 31, y: 14, w: 14 },
      { img: "images/kardex_page8_details3.png", x: 31, y: 47, w: 14 },
    );

    // Elements
    const pageImg   = document.getElementById("pageImg");
    const overlaysEl= document.getElementById("overlays");
    const pageLabel = document.getElementById("pageLabel");
    const prevBtn   = document.getElementById("prevBtn");
    const nextBtn   = document.getElementById("nextBtn");

    const p2Panel  = document.getElementById("p2Panel");
    const p2Bubble = document.getElementById("p2Bubble");
    const p8Panel  = document.getElementById("p8Panel");
    const p8Next   = document.getElementById("p8Next");

    const P2_INDEX = 1;
    const P8_INDEX = 7;

    // Persistence keys
    const P2_KEYS = {
      panelShown:   "nightshift_kardex_p2_panel_shown",
      pharmacyDone: "nightshift_kardex_p2_called_pharmacy",
      wifeDone:     "nightshift_kardex_p2_called_wife",
      detailsShown: "nightshift_kardex_p2_details_shown"
    };
    const P8_KEYS = {
      internDone:   "nightshift_kardex_p8_called_intern",
      clerkingDone: "nightshift_kardex_p8_called_clerking",
      arrestDone:   "nightshift_kardex_p8_arrest_call"
    };

    // state.js integration
    let addScore  = (n)=>{};
    let addSocial = (n)=>{};
    try{
      const mod = await import("./js/state.js");
      mod.ensureTimerStarted?.();
      if (typeof mod.addScore === "function") addScore = mod.addScore;
      if (typeof mod.addSocial === "function") addSocial = mod.addSocial;
    }catch(e){
      console.warn("state.js not loaded:", e);
    }

    let pageIndex = 0;
    {
      const params = new URLSearchParams(window.location.search);
      const p = Number(params.get("page") || "0");
      if (p && Number.isFinite(p)) pageIndex = Math.min(NUM_PAGES, Math.max(1, p)) - 1;
    }

    function showP2Bubble(text, ms){
      p2Bubble.textContent = text;
      p2Bubble.classList.add("is-visible");
      clearTimeout(showP2Bubble._t);
      showP2Bubble._t = setTimeout(()=>p2Bubble.classList.remove("is-visible"), ms);
    }

    function renderOverlays(page, opts = {}){
      overlaysEl.innerHTML = "";
      (page.overlays || []).forEach(o => {
        if (o.id === "p2_details2" && localStorage.getItem(P2_KEYS.detailsShown) !== "1") return;

        const el = document.createElement("div");
        el.className = "overlay";
        el.style.left = `${o.x}%`;
        el.style.top  = `${o.y}%`;
        el.style.width= `${o.w}%`;

        const img = document.createElement("img");
        img.src = o.img;
        img.alt = "";
        el.appendChild(img);
        overlaysEl.appendChild(el);

        if (opts.animateP2Details && o.id === "p2_details2") {
          if (localStorage.getItem("nightshift_p2_details2_animated") !== "1") {
            localStorage.setItem("nightshift_p2_details2_animated", "1");
            el.classList.remove("wipe-in");
            void el.offsetWidth;
            el.classList.add("wipe-in");
          }
        }
      });
    }

    function buildP2Panel(){
      if (p2Panel.dataset.built === "1") return;
      p2Panel.dataset.built = "1";

      p2Panel.innerHTML = `
        <button class="p2-tile" type="button" data-action="pharmacy">Call his pharmacy?</button>
        <button class="p2-tile" type="button" data-action="wife">Call his wife?</button>
        <button class="p2-tile" type="button" data-action="keep">Keep reading</button>
      `;

      p2Panel.addEventListener("click",(e)=>{
        const btn = e.target.closest(".p2-tile");
        if (!btn) return;

        const action = btn.dataset.action;

        if (action === "pharmacy"){
          if (localStorage.getItem(P2_KEYS.pharmacyDone) !== "1"){
            addSocial(3);
            addScore(3);
            localStorage.setItem(P2_KEYS.pharmacyDone, "1");
          }
          localStorage.setItem(P2_KEYS.detailsShown, "1");
          if (pageIndex === P2_INDEX) renderOverlays(KARDEX_PAGES[pageIndex], { animateP2Details: true });

          showP2Bubble(
            "He last picked up his script a month ago. He’s definitely not fully adherent. He’s called us for an emergency script a couple of times because he’s run out of medications.",
            3000
          );
        }

        if (action === "wife"){
          if (localStorage.getItem(P2_KEYS.wifeDone) !== "1"){
            addSocial(1);
            localStorage.setItem(P2_KEYS.wifeDone, "1");
          }
          showP2Bubble(
            "I have no idea. I’m sorry. He’s just on so much. I can bring his script in tomorrow when I collect it.",
            2000
          );
        }

        // keep = no score, no bubble necessary (panel stays)
      });
    }

    function showP2PanelSticky(){
      buildP2Panel();
      p2Panel.classList.remove("hidden");
      requestAnimationFrame(()=>p2Panel.classList.add("is-visible"));
    }

    function scheduleP2PanelIfNeeded(){
      if (localStorage.getItem(P2_KEYS.panelShown) === "1") return;
      if (pageIndex !== P2_INDEX) return;

      localStorage.setItem(P2_KEYS.panelShown, "pending");
      setTimeout(()=>{
        localStorage.setItem(P2_KEYS.panelShown, "1");
        showP2PanelSticky();
      }, 2000);
    }

    function buildP8Panel(){
      if (p8Panel.dataset.built === "1") return;
      p8Panel.dataset.built = "1";

      p8Panel.innerHTML = `
        <button class="p8-tile" type="button" data-action="intern">Call the intern</button>
        <button class="p8-tile" type="button" data-action="clerking">Call the clerking doctor</button>
        <button class="p8-tile" type="button" data-action="arrest">Put out arrest call</button>
      `;

      p8Panel.addEventListener("click",(e)=>{
        const btn = e.target.closest(".p8-tile");
        if (!btn) return;

        const action = btn.dataset.action;

        if (action === "intern"){
          if (localStorage.getItem(P8_KEYS.internDone) !== "1"){
            addSocial(1);
            addScore(1);
            localStorage.setItem(P8_KEYS.internDone, "1");
          }
          window.location.href = "workbench3.html";
        }

        if (action === "clerking"){
          if (localStorage.getItem(P8_KEYS.clerkingDone) !== "1"){
            addSocial(3);
            addScore(3);
            localStorage.setItem(P8_KEYS.clerkingDone, "1");
          }
          window.location.href = "workbench3.html";
        }

        if (action === "arrest"){
          if (localStorage.getItem(P8_KEYS.arrestDone) !== "1"){
            // no scoring by design
            localStorage.setItem(P8_KEYS.arrestDone, "1");
          }
          window.location.href = "workbench3.html";
        }
      });
    }

    function showP8Panel(){
      buildP8Panel();
      p8Panel.classList.remove("hidden");
      requestAnimationFrame(()=>p8Panel.classList.add("is-visible"));
    }

    function updateP8UI(){
      if (pageIndex === P8_INDEX){
        showP8Panel();

        // ✅ Arrow should be visible immediately on page 8
        p8Next.classList.remove("hidden");
      } else {
        p8Panel.classList.add("hidden");
        p8Next.classList.add("hidden");
      }
    }

    p8Next.addEventListener("click", ()=>{
      window.location.href = "thrombolysischeck.html";
    });

    function renderPage(){
      const page = KARDEX_PAGES[pageIndex];

      pageLabel.textContent = `Page ${pageIndex + 1} / ${KARDEX_PAGES.length}`;
      prevBtn.disabled = (pageIndex === 0);
      nextBtn.disabled = (pageIndex === KARDEX_PAGES.length - 1);

      pageImg.src = page.img;
      pageImg.alt = page.title;

      renderOverlays(page);

      if (localStorage.getItem(P2_KEYS.panelShown) === "1") showP2PanelSticky();
      scheduleP2PanelIfNeeded();

      updateP8UI();
    }

    prevBtn.addEventListener("click", ()=>{
      if (pageIndex > 0){ pageIndex--; renderPage(); }
    });
    nextBtn.addEventListener("click", ()=>{
      if (pageIndex < KARDEX_PAGES.length - 1){ pageIndex++; renderPage(); }
    });

    renderPage();
  </script>
</body>
</html>
