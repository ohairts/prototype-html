<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Next Most Important Question</title>

  <link rel="stylesheet" href="css/common.css">
  <link href="https://fonts.googleapis.com/css2?family=Roboto+Slab:wght@900&display=swap" rel="stylesheet">

  <style>
    body{
      margin:0;
      background:#0b3b4a;
      font-family:"Roboto Slab", serif;
      overflow:hidden;
    }

    .stage{
      width:100vw;
      height:100vh;
      position:relative;
      background:#08394a;
      overflow:hidden;
    }

    /* ===== LEFT RED OVAL ===== */
    .left-oval{
      position:absolute;
      left: 40px;
      top: 80px;
      width: min(360px, 32vw);
      height: min(620px, 72vh);
      background: #ff0000;
      border-radius: 999px;
      box-shadow: 0 0 40px rgba(255,120,0,.25);
      border: 6px solid rgba(0,0,0,.25);
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 30px;
      z-index: 2;
    }
    .left-oval .left-text{
      color:#000;
      font-weight: 900;
      font-size: clamp(22px, 2.2vw, 40px);
      line-height: 1.08;
      text-align:center;
      text-shadow: none;
    }

    /* ===== CENTER IMAGE ===== */
    .hero{
      position:absolute;
      left:50%;
      top:50%;
      transform: translate(-50%, -50%);
      width: min(640px, 46vw);
      height: min(720px, 84vh);
      background: url("images/rushingtoresus.png") center / cover no-repeat; /* <-- CHANGE */
      border: 3px solid rgba(0,0,0,.45);
      box-shadow: 0 18px 45px rgba(0,0,0,.45);
      z-index: 1;
    }

    /* ===== RIGHT HEADER ===== */
    .right-header{
      position:absolute;
      right: 50px;
      top: 40px;
      width: min(520px, 38vw);
      background:#ffc400;
      border-radius: 14px;
      padding: 18px 18px;
      border: 4px solid rgba(0,0,0,.35);
      box-shadow: 0 14px 22px rgba(0,0,0,.25);
      text-align:center;
      z-index: 5;
    }
    .right-header .htext{
      color:#000;
      font-weight: 900;
      font-size: clamp(20px, 2.2vw, 34px);
      line-height: 1.1;
      margin:0;
    }

    /* ===== RIGHT ANSWER BUTTONS ===== */
    .answers{
      position:absolute;
      right: 70px;
      top: 170px;
      width: min(480px, 34vw);
      display:flex;
      flex-direction: column;
      gap: 18px;
      z-index: 5;
    }

    .answer{
      background:#5aa2e7;
      color:#fff;
      border-radius: 6px;
      padding: 26px 20px;
      text-align:center;
      font-weight: 900;
      font-size: clamp(16px, 1.6vw, 24px);
      cursor:pointer;
      user-select:none;

      border: 4px solid rgba(0,0,0,.25);
      box-shadow: inset 0 0 0 3px rgba(255,255,255,.25),
                  0 14px 22px rgba(0,0,0,.25);
      transition: transform .12s ease, filter .12s ease;
    }
    .answer:hover{ transform: translateY(-2px); filter: brightness(1.05); }
    .answer:active{ transform: translateY(1px) scale(.995); filter: brightness(.98); }

    .answer.locked{ cursor: default; }
    .answer.correct{
      outline: 5px solid rgba(255,196,0,.90);
      filter: brightness(1.08);
    }
    .answer.wrong{ opacity: .60; }

/* ===== SLIDE-ONLY SPEECH BUBBLE OVERRIDE (WHITE) ===== */
   .bubble{
      position: absolute;
      right: 70px;
      top: 120px;
      width: min(520px, 38vw);
      min-height: 78px;
      padding: 18px 22px;

      background: #fff;
      color: #111;

      border: 4px solid rgba(0,0,0,.28);
      border-radius: 999px;
      box-shadow: 0 14px 22px rgba(0,0,0,.25);

      font-family: "Roboto Slab", serif;
      font-weight: 900;
      font-size: clamp(16px, 1.6vw, 22px);
      line-height: 1.2;

      opacity: 0;
      transform: translate(16px, 10px) scale(.98);
      pointer-events: none;
      transition: opacity .18s ease, transform .18s ease;
      z-index: 50;
    }

    .bubble.is-visible{
      opacity: 1;
      transform: translate(0,0) scale(1);
    }

    .bubble::after{
      content:"";
      position:absolute;

      right: 460px;
      bottom: -110px;

      border-left: 12px solid transparent;
      border-right: 12px solid transparent;
      border-top: 120px solid #fff;

      transform: rotate(35deg);
      transform-origin: top center;

      filter: drop-shadow(0 8px 0 rgba(0,0,0,.14));
    }

    /* ===== NEW MINIMAL STOPWATCH ===== */
    .stopwatch-wrap{
      position:absolute;
      left: 50%;
      bottom: 44px;
      transform: translateX(-50%);
      width: 150px;
      height: 150px;
      z-index: 8;
      pointer-events:none;
      filter: drop-shadow(0 10px 18px rgba(0,0,0,.35));
    }

    .sw{ width:100%; height:100%; display:block; }
    .sw-outline{ fill: rgba(0,0,0,.10); stroke: rgba(255,255,255,.92); stroke-width: 7; }
    .sw-face{ fill: rgba(0,0,0,.18); stroke: rgba(255,255,255,.18); stroke-width: 2; }

    .sw-pie{
      width: 100%;
      height: 100%;
      border-radius: 999px;
      background: conic-gradient(from -90deg, rgba(255,234,0,.92) var(--p, 0%), rgba(255,234,0,0) 0);
      -webkit-mask: radial-gradient(circle, #000 62%, transparent 63%);
              mask: radial-gradient(circle, #000 62%, transparent 63%);
      opacity: .95;
      animation: pieFill 10s linear forwards;
    }

    .sw-ring{
      fill: none;
      stroke: rgba(255,234,0,.95);
      stroke-width: 9;
      stroke-linecap: round;
      stroke-dasharray: 276.46;
      stroke-dashoffset: 276.46;
      transform: rotate(-90deg);
      transform-origin: 60px 66px;
      animation: ringFill 10s linear forwards;
    }

    .sw-hand{ stroke: rgba(255,255,255,.92); stroke-width: 6; stroke-linecap: round; opacity: .95; }
    .sw-top{ fill: rgba(255,255,255,.92); opacity: .92; }

    @keyframes ringFill{ to { stroke-dashoffset: 0; } }
    @keyframes pieFill{ to { --p: 100%; } }

    /* ===== GREEN NEXT ARROW (BOTTOM RIGHT) ===== */
    .next{
      position:absolute;
      right: 70px;
      bottom: 60px;
      width: 120px;
      height: 90px;
      background:#0aa84f;
      border: 4px solid rgba(0,0,0,.45);
      box-shadow: 0 14px 26px rgba(0,0,0,.35);
      display:grid;
      place-items:center;
      cursor:pointer;
      user-select:none;
      z-index: 20;
      transition: transform .12s ease, filter .12s ease;

      opacity: 0;
      pointer-events:none;
      transform: translateY(10px) scale(.98);
    }
    .next.is-visible{
      opacity: 1;
      pointer-events:auto;
      transform: translateY(0) scale(1);
    }
    .next:hover{ transform: translateY(-2px) scale(1.01); filter: brightness(1.05); }
    .next:active{ transform: translateY(1px) scale(.99); filter: brightness(.98); }

    .next::before{
      content:"";
      width:0; height:0;
      border-top: 26px solid transparent;
      border-bottom: 26px solid transparent;
      border-left: 44px solid rgba(0,0,0,.55);
      transform: translateX(4px);
    }
    .next::after{
      content:"";
      position:absolute;
      width:0; height:0;
      border-top: 24px solid transparent;
      border-bottom: 24px solid transparent;
      border-left: 40px solid rgba(0,0,0,.20);
      transform: translateX(7px);
      opacity:.55;
      pointer-events:none;
    }

    /* responsive */
    @media (max-width: 980px){
      .left-oval{ left: 18px; top: 70px; }
      .right-header{ right: 18px; }
      .answers{ right: 18px; width: min(520px, 46vw); }
      .bubble{ right: 18px; width: min(520px, 46vw); }
      .next{ right: 18px; bottom: 18px; }
      .stopwatch-wrap{ bottom: 18px; }
    }
  </style>
</head>

<body>
  <div class="stage">

    <div class="left-oval">
      <div class="left-text">
        The registrar’s<br>
        arrived and<br>
        has assessed<br>
        Patrick. A<br>
        student nurse<br>
        arrives to say<br>
        he has to go<br>
        to the CT<br>
        scanner.
      </div>
      <audio id="tickAudio" src="audio/clocktickingdown.mp3" preload="auto"></audio>
    </div>

    <div class="hero" aria-hidden="true"></div>

    <div class="right-header">
      <p class="htext">What’s the next most<br>important question ?<br>(only ask one)</p>
    </div>

    <div class="answers" id="answers">
      <div class="answer" data-correct="false"
           data-reply="The finger prick was 7."
           data-duration="2500">
        Do you normally check your<br>blood sugars?
      </div>

      <div class="answer" data-correct="false"
           data-reply="Well I take an aspirin alright."
           data-duration="2500">
        Do you take a blood thinner?
      </div>

      <div class="answer" data-correct="true"
           data-reply="Oh I’d say it was half four. I guess its six now."
           data-duration="3000">
        What time were you last<br>well?
      </div>
    </div>

    <!-- Speech bubble -->
    <div id="bubble" class="bubble"></div>

    <!-- Stopwatch -->
    <!-- Stopwatch -->
    <div class="stopwatch-wrap" aria-hidden="true">
      <svg class="sw" viewBox="0 0 120 120" role="img" aria-label="Stopwatch">
        <circle cx="60" cy="66" r="52" class="sw-outline"/>
        <circle cx="60" cy="66" r="44" class="sw-face"/>

        <foreignObject x="16" y="22" width="88" height="88">
          <div class="sw-pie"></div>
        </foreignObject>

        <circle cx="60" cy="66" r="44" class="sw-ring"/>
        <line x1="60" y1="66" x2="60" y2="38" class="sw-hand"/>
        <rect x="52" y="6" width="16" height="12" rx="3" class="sw-top"/>
        <rect x="44" y="18" width="32" height="10" rx="5" class="sw-top"/>
      </svg>
    </div>

    <!-- Next arrow (shows on any answer OR at 10s) -->
    <div id="nextBtn" class="next" title="Continue"></div>

  </div>
  <script type="module">
    // state.js integration (safe) + overall scoring for correct selection only
    let addScore = (n)=>{};
    try{
      const mod = await import("./js/state.js");
      mod.ensureTimerStarted?.();
      if (typeof mod.addScore === "function") addScore = mod.addScore;
    }catch(e){}

    // ---- 10s ticking audio on load (loops 8s clip smoothly) ----
    const tickAudio = document.getElementById("tickAudio");

    async function playTickFor10s(){
      if (!tickAudio) return;

      tickAudio.loop = true;
      tickAudio.currentTime = 0;

      try{
        await tickAudio.play();
      }catch(err){
        const startOnFirstTap = async () => {
          try{ await tickAudio.play(); }catch(e){}
          window.removeEventListener("pointerdown", startOnFirstTap);
          window.removeEventListener("keydown", startOnFirstTap);
        };
        window.addEventListener("pointerdown", startOnFirstTap, { once: true });
        window.addEventListener("keydown", startOnFirstTap, { once: true });
      }

      setTimeout(() => {
        try{
          tickAudio.pause();
          tickAudio.currentTime = 0;
        }catch(e){}
      }, 10000);
    }
    playTickFor10s();

    const answersEl = document.getElementById("answers");
    const bubble = document.getElementById("bubble");
    const nextBtn = document.getElementById("nextBtn");

    const NEXT_HREF = "medworkbench3.html";
    const CORRECT_POINTS = 3; // <-- overall points for correct question

    let locked = false;
    let hideTimer = null;
    let arrowShown = false;
    let scoreAwarded = false;

    function showBubble(text, ms){
      if (hideTimer) clearTimeout(hideTimer);
      bubble.textContent = text;
      bubble.classList.add("is-visible");
      hideTimer = setTimeout(() => bubble.classList.remove("is-visible"), ms);
    }

    function showNextArrow(){
      if (arrowShown) return;
      arrowShown = true;
      nextBtn.classList.add("is-visible");
    }

    answersEl.addEventListener("click", (e) => {
      const btn = e.target.closest(".answer");
      if (!btn || locked) return;

      locked = true;

      const isCorrect = btn.dataset.correct === "true";
      const reply = btn.dataset.reply || "";
      const duration = Number(btn.dataset.duration || 2500);

      showBubble(reply, duration);

      [...answersEl.querySelectorAll(".answer")].forEach(a => a.classList.add("locked"));
      btn.classList.add(isCorrect ? "correct" : "wrong");
      [...answersEl.querySelectorAll(".answer")].forEach(a => { if (a !== btn) a.classList.add("wrong"); });

      // ✅ OVERALL SCORE ONLY IF CORRECT
      if (isCorrect && !scoreAwarded){
        addScore(CORRECT_POINTS);
        scoreAwarded = true;
      }

      showNextArrow();
    });

    nextBtn.addEventListener("click", () => {
      window.location.href = NEXT_HREF;
    });

    // Timer rule: at 10 seconds, show arrow even if no selection
    setTimeout(showNextArrow, 10000);
  </script>
</body>
</html>
